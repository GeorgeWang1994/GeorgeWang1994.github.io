
# Djangoè¿ç§»ä¸»é”®æ€»ç»“

## èƒŒæ™¯



å› ä¸ºå½“å‰é¡¹ç›®ä¸­çš„è¡¨ä¸­ä½¿ç”¨äº†éå¸¸å¤šçš„å¤–é”®æ¥å…³è”è¡¨ï¼Œè¿™å°±ä¼šå¯¼è‡´å½“æ›´æ–°ä¸»è¡¨çš„`id`çš„æ—¶å€™ï¼Œå¯¼è‡´æ‰€æœ‰ç›¸å…³è”çš„è¡¨å…¨éƒ¨éƒ½è¦æ›´æ–°ï¼Œè‡³äºä¸ºä»€ä¹ˆä¼šæ›´æ–°`id`ï¼Œæˆ‘è®¤ä¸ºæ˜¯å½“åˆè®¾è®¡è¡¨çš„äººæ²¡æœ‰ç†è§£è¿™ä¸ªè¡¨çš„å«ä¹‰ï¼Œå¯¹äºè¡¨ä¸­çš„ä¸€ä¸ªå®ä¾‹æ•°æ®ï¼Œå®ƒä»£è¡¨çš„å°±æ˜¯ç‰¹å®šçš„ä¸€ä¸ªä¸œè¥¿ï¼Œè€Œè¿™ä¸ªä¸œè¥¿çš„`id`ä¸åº”è¯¥æ˜¯ä¼šå»æ”¹å˜çš„ï¼Œä½†æ˜¯å®ƒæ˜¯å’ŒDockerä¸­çš„`container_id`å»ç»‘å®šçš„ï¼Œè€ŒDockeråœ¨é‡å¯çš„æ—¶å€™å°±ä¼šé‡æ–°åˆ†é…`container_id`ï¼Œè€Œå¦‚æœæƒ³æŠŠå…¶ä»–å…³è”çš„æ•°æ®éƒ½è¦å’Œä¹‹å‰ä¸€æ ·ï¼Œå°±ä¸å¾—ä¸å»æ›´æ–°ç›¸å…³è”çš„è¡¨çš„å¤–é”®idï¼Œå¹¶ä¸”å¦‚æœè¿™äº›å…³è”çš„æ•°æ®é‡å¦‚æœå·¨å¤§ï¼Œæ›´æ–°å°±å˜æˆä¸€ä¸ªéå¸¸ä¸åˆ’ç®—çš„æ“ä½œï¼Œå› æ­¤æˆ‘æƒ³åˆ°äº†é‡æ–°è®¾è®¡è¡¨ï¼Œå…·ä½“çš„åŸå› å¦‚ä¸‹ï¼š



1. å…³è”è¡¨æ•°æ®é‡å¤§ï¼Œæ›´æ–°æ“ä½œè€—è´¹æ—¶é—´ï¼Œå³ä½¿æ”¾è¿›ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯æœŸé—´å¦‚æœæ–°å¢çš„å…³è”æ•°æ®è¿˜æ˜¯ä¹‹å‰çš„idï¼Œé‚£ä¹ˆé—®é¢˜å°±ä¼šå˜å¾—æ¯”è¾ƒå¤æ‚ï¼›
2. è¡¨çš„è®¾è®¡ä¸åˆç†ï¼Œåº”è¯¥ç»´æŠ¤`container_id`ï¼Œè€Œä¸æ˜¯ä»¥å¯å˜çš„`container_id`ä½œä¸ºä¸»é”®ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨å»æ›´æ”¹å…¶ä»–å…³è”è¡¨çš„å¤–é”®ï¼›



## ç›¸å…³è¡¨&éœ€æ±‚



ä»¥ä¸‹æ˜¯ä¹‹å‰çš„è¡¨çš„è®¾è®¡ï¼š

```python
from django.db import models


class HP(models.Model):
    id = models.CharField(max_length=20, unique=True, null=False, blank=False)
    name = models.CharField(max_length=20, default="")


class AG(models.Model):
    id = models.CharField(max_length=20, primary_key=True)
    name = models.CharField(max_length=20, default="")
    hps = models.ManyToManyField(HP, related_name='ags', blank=True)


class CN(models.Model):
    id = models.CharField(max_length=20, primary_key=True)
    name = models.CharField(max_length=20, default="")
    hp = models.ForeignKey(HP, on_delete=models.SET_NULL, null=True)

```



æˆ‘ä»¬è¦å®ç°çš„æ˜¯å¢åŠ ä¸€ä¸ªä¸»é”®çš„`id`ï¼ŒåŸæ¥çš„`id`å­—æ®µåæ›´æ”¹ä¸º`cid`ï¼Œå¹¶ä¸”æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®ä¸ä¼šå‘ç”Ÿä»»ä½•çš„å˜åŒ–ã€‚



## å…·ä½“çš„æ“ä½œ



### ğŸ. å†é€ ä¸€ä¸ªè¡¨



ä¹Ÿå°±æ˜¯æ–°å¢äº†ä¸€å¼ æœ€ç»ˆæƒ³è¦çš„è¡¨ï¼Œç„¶åå°†ä¹‹å‰è¡¨çš„æ•°æ®å…¨éƒ¨è¿ç§»åˆ°è¿™å¼ è¡¨ä¸Šå»ï¼Œæœ€åæŠŠä¹‹å‰çš„è¡¨çš„æ•°æ®ç»™åˆ é™¤æ‰ã€‚



å…·ä½“çš„migrationæ“ä½œå¦‚ä¸‹ï¼š



```python
# Generated by Django 2.2 on 2019-05-30 11:46

import django
from django.db import migrations, models


def move_hp_data(apps, schema_editor):
    HPModel = apps.get_model("hp", "HP")
    HPTempModel = apps.get_model("hp", "HPTemp")

    hp_qs = HPModel.objects.all()
    for hp in hp_qs:
        HPTempModel.objects.create(
            id=hp.id, cid=hp.id, name=hp.name,
        )


class Migration(migrations.Migration):

    dependencies = [
        ('hp', '0003_auto_20190530_1140'),
    ]

    operations = [
        # 1. æ–°å¢è¡¨
        migrations.CreateModel(
            name='HPTemp',
            fields=[
                ('id', models.CharField(max_length=20, primary_key=True, verbose_name='ID')),
                ('cid', models.CharField(max_length=20, unique=True)),
                ('name', models.CharField(default='', max_length=20)),
            ],
        ),
        # 2. è¿ç§»è¡¨æ•°æ®
        migrations.RunPython(move_hp_data),
        # 3. æ›´æ”¹å…³è”çš„å¤–é”®
        migrations.AlterField(
            model_name='ag',
            name='hps',
            field=models.ManyToManyField(blank=True, related_name='ags', to='hp.HPTemp'),
        ),
        migrations.AlterField(
            model_name='cn',
            name='hp',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='hp.HPTemp'),
        ),
        # 4. åˆ é™¤åŸæ¥çš„è¡¨
        migrations.DeleteModel(
            name='HP',
        ),
        # 5. é‡æ–°å‘½åä¸ºåŸå…ˆçš„è¡¨
        migrations.RenameModel('HPTemp', 'HP'),
        # 6. æ›´æ”¹å…³è”çš„å¤–é”®
        migrations.AlterField(
            model_name='AG',
            name='hps',
            field=models.ManyToManyField(blank=True, related_name='ags', to='hp.HP'),
        ),
        migrations.AlterField(
            model_name='CN',
            name='hp',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='hp.HP'),
        ),
    ]
```



æ‰§è¡Œ`makemigration`åå¯ä»¥å‘ç°ï¼Œä¼šæ˜¾ç¤ºæ²¡æœ‰ä»€ä¹ˆå¯ä»¥æ”¹å˜çš„ï¼Œæ¥ç€è¿›è¡Œ`migrate`æ“ä½œï¼Œå‘ç°æ•°æ®åº“ä¹Ÿæ²¡æœ‰å‘ç”Ÿä»»ä½•çš„å˜åŒ–ï¼ŒæˆåŠŸï¼ï¼



å¦‚æœå®ƒä»¬åˆ†åˆ«æ•£å¸ƒåœ¨ä¸åŒçš„appå½“ä¸­ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨æ„æ‰§è¡Œçš„é¡ºåºï¼Œéœ€è¦æ”¹åŠ¨åˆ°`dependencies`ä¸­çš„æ–‡ä»¶ï¼Œæœ€ååœ¨makemigrationsçš„æ—¶å€™éœ€è¦æ³¨æ„å…¶äº’ç›¸ä¾èµ–çš„é¡ºåºã€‚



### ğŸ±. åœ¨åŸæ¥è¡¨çš„åŸºç¡€ä¸Šä¿®æ”¹



å› ä¸ºæˆ‘ä»¬å¢åŠ çš„è¿™ä¸ªIDåªéœ€è¦ä¿è¯å”¯ä¸€æ€§ï¼Œå¯¹äºå…¶å†…å®¹æ²¡æœ‰ä»€ä¹ˆè¦æ±‚ï¼Œå› æ­¤ä¿ç•™åŸæ¥çš„ä¸»é”®ï¼Œæ–°å¢ä¸€ä¸ªå”¯ä¸€çš„é”®å»è®°å½•å˜æ›´çš„å®¹å™¨IDå³å¯ï¼Œè€Œä¸”è¿™ä¹ˆåšè¿˜å¯ä»¥ä¿è¯åŸå…ˆä¸»é”®å…³è”çš„æ‰€æœ‰è¡¨çš„æ•°æ®éƒ½ä¸éœ€è¦æ›´æ–°ï¼Œå› æ­¤è¿™æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ–¹æ³•ï¼ˆå…·ä½“çš„å®ç°å’Œä¸Šé¢æ˜¯ç±»ä¼¼çš„ï¼‰ã€‚



ä½†æ˜¯å¦‚æœè¿™å¼ è¡¨çš„æ•°é‡å¾ˆå¤§ï¼Œé‚£ä¹ˆæ‹·è´è¿™å¼ è¡¨çš„æ•°æ®å°±ä¼šå˜å¾—å¾ˆåƒåŠ›ï¼Œå› æ­¤å¦‚æœå¯ä»¥çš„è¯ï¼Œåœ¨åŸæ¥çš„è¡¨çš„åŸºç¡€ä¸Šè¿›è¡Œæ–°å¢æƒ³è¦çš„å­—æ®µï¼Œå†å°†è¯¥å­—æ®µå˜æˆä¸ºä¸»é”®ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ



ä¸Šé¢é‚£ç§æ–¹æ³•è¿™ç§é˜²èŒƒæ¯”è¾ƒç¹çï¼Œéœ€è¦æ”¹åŠ¨çš„ä¸œè¥¿ä¹Ÿæ¯”è¾ƒå¤šã€‚å…·ä½“å¯ä»¥å‚è€ƒ[è¿™é‡Œ](http://salvalcantara.com/blog/the-motherfucker-migration/#fn:3)

